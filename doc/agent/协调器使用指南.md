# 协调器（Coordinator）使用指南

## 📋 概述

QTRAN v1.7 引入了轻量级协调器机制（SimpleCoordinator），实现了基于黑板模式的动态工作流调整。协调器可以从 Mem0 读取反馈信息（Recommendation 和 CoverageHotspot），并自动调整翻译参数以提升测试效率。

## 🎯 核心功能

### 1. 状态轮询（Poll State）
从 Mem0 黑板读取：
- **Recommendation**：变异测试生成的翻译建议
- **CoverageHotspot**：高覆盖率增长的特性组合

### 2. 策略决策（Decide Strategy）
基于轮询状态自动决策：
- 是否调整 LLM temperature（降低随机性）
- 是否调整迭代次数（增加重试机会）
- 是否启用高优先级模式
- 重点关注哪些 SQL 特性

### 3. 参数调整（Adjust Workflow）
动态修改翻译流程参数：
- `temperature`：0.3 → 0.2（高优先级建议时）
- `iteration_num`：4 → 6（高覆盖率 Hotspot 时）

## 🚀 使用方法

### 方法 1：默认启用（推荐）

协调器默认启用，只需确保设置了 `QTRAN_USE_MEM0=true`：

```bash
export QTRAN_USE_MEM0=true
export OPENAI_API_KEY="your_key"
export HTTP_PROXY="http://127.0.0.1:7890"
export HTTPS_PROXY="http://127.0.0.1:7890"

# 运行翻译任务，协调器会自动工作
python -m src.main --input_filename Input/nosql2sqldemo_agent.jsonl --tool sqlancer
```

### 方法 2：显式启用

通过命令行参数显式启用：

```bash
python -m src.main \
  --input_filename Input/nosql2sqldemo_agent.jsonl \
  --tool sqlancer \
  --enable_coordinator True
```

### 方法 3：禁用协调器

如果需要禁用协调器（使用默认参数）：

```bash
python -m src.main \
  --input_filename Input/nosql2sqldemo_agent.jsonl \
  --tool sqlancer \
  --enable_coordinator False
```

或者不设置 `QTRAN_USE_MEM0` 环境变量。

## 📊 运行输出

### 初始化阶段

```
============================================================
🧠 初始化协调器（Coordinator）
============================================================
✅ 协调器：Mem0 连接成功
📡 轮询黑板状态...
🤔 分析反馈并决策策略...
⚙️ 应用策略调整...
🎯 协调器：调整 temperature → 0.2
🎯 协调器：调整 iteration_num → 6
🚀 协调器：高优先级模式激活
   推荐动作: 优先生成包含 HEX() 和聚合函数的 SQL
🔍 协调器：重点关注特性 → HEX, MIN, aggregate
✅ 协调器初始化完成
```

### 任务结束时

```
============================================================
📊 协调器运行统计
============================================================
  总 Recommendation 数: 12
  高优先级建议数: 3
  应用的建议数: 3
  检测到的 Hotspot 数: 5
  策略调整次数: 4
============================================================
```

## 🔧 配置选项

### 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `QTRAN_USE_MEM0` | 启用 Mem0（协调器必需） | `false` |
| `OPENAI_API_KEY` | OpenAI API 密钥 | - |
| `HTTP_PROXY` | HTTP 代理 | - |
| `HTTPS_PROXY` | HTTPS 代理 | - |

### 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--enable_coordinator` | 启用协调器 | `True` |
| `--temperature` | 基础 temperature | `0.3` |
| `--iteration_num` | 基础迭代次数 | `4` |
| `--model` | LLM 模型 | `gpt-4o-mini` |

## 🧠 决策规则

协调器使用以下规则进行决策：

### 规则 1：高优先级建议 → 降低随机性

```python
if has_high_priority_recommendation (priority >= 8):
    temperature = 0.2  # 降低 temperature
    priority_boost = True
    extract focus_features from recommendation
```

**效果**：提升翻译稳定性，优先生成建议的特性。

### 规则 2：高覆盖率 Hotspot → 增加迭代

```python
if hotspot.avg_coverage_gain > 10:
    iteration_num = 6  # 增加迭代次数
```

**效果**：给予更多重试机会，提升成功率。

### 规则 3：无反馈 → 探索模式

```python
if no_recommendations and no_hotspots:
    recommended_action = "探索模式：正常执行翻译流程"
```

**效果**：保持默认参数，正常探索。

## 📈 预期效果

根据 DCFF 设计文档预期：

| 指标 | 预期提升 |
|------|---------|
| Bug 检出率 | +20-30% |
| 覆盖率增长速度 | +30-40% |
| 测试效率 | +15-25% |
| 首次成功率 | ~90% |

## 🔍 故障排查

### 问题 1：协调器未启动

**现象**：
```
ℹ️ 协调器未启用：需要设置 QTRAN_USE_MEM0=true
```

**解决**：
```bash
export QTRAN_USE_MEM0=true
```

### 问题 2：Mem0 连接失败

**现象**：
```
⚠️ 协调器：Mem0 初始化失败 (ConnectionError)，协调功能部分受限
```

**解决**：
1. 检查 Mem0 服务是否运行
2. 检查网络连接
3. 检查 `TransferMemoryManager` 配置

### 问题 3：无 Recommendation 生成

**现象**：统计报告显示 `总 Recommendation 数: 0`

**原因**：
- 首次运行时还没有变异测试反馈
- 变异测试未发现 Oracle 失败

**建议**：
- 运行多轮测试积累反馈
- 检查变异测试是否正常运行

## 🎯 最佳实践

### 1. 渐进式启用

```bash
# 第一次运行：收集基准数据（禁用协调器）
python -m src.main --input_filename input.jsonl --tool sqlancer --enable_coordinator False

# 第二次运行：启用协调器，观察效果
python -m src.main --input_filename input.jsonl --tool sqlancer --enable_coordinator True
```

### 2. 监控统计数据

关注协调器运行统计：
- **应用的建议数 > 0**：说明反馈机制生效
- **策略调整次数 > 0**：说明协调器在动态调整参数
- **高优先级建议数**：反映系统发现的高价值特性

### 3. 结合 Mem0 检查

```python
from src.TransferLLM.TransferMemoryManager import TransferMemoryManager

manager = TransferMemoryManager(user_id="qtran_redis_to_mongodb")

# 查看所有 Recommendation
recs = manager.get_all_recommendations(limit=20)
for rec in recs:
    print(f"Priority: {rec['priority']}, Action: {rec.get('action_directive', 'N/A')}")

# 查看所有 Hotspot
hotspots = manager.get_all_hotspots(limit=10)
for hotspot in hotspots:
    print(f"Features: {hotspot['features']}, Coverage Gain: {hotspot['avg_coverage_gain']}")
```

## 📚 相关文档

- [当前系统 vs DCFF 设计对比](../research/重要/当前系统_vs_DCFF设计对比.md)
- [TransferMemoryManager API](../src/TransferLLM/TransferMemoryManager.py)
- [Recommendation 和 Hotspot 设计](../research/重要/当前系统_vs_DCFF设计对比.md#1-反向反馈机制)

## 🔄 下一步计划

根据设计文档，协调器可以进一步演进：

1. **阶段 2**：封装独立的 Translation Agent 和 Mutation Agent
2. **阶段 3**：实现完整的黑板架构和更复杂的策略决策
3. **未来**：支持更多实体（TranslationPattern、MutationStep、CaseHistory）

当前的 `SimpleCoordinator` 是最小可行版本（MVP），提供了核心的反向反馈和动态调整功能。

---

**版本**：v1.7  
**更新日期**：2025-10-27  
**状态**：✅ 可用


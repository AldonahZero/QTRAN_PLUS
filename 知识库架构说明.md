# QTRAN知识库架构完整说明

## 🏗️ 三层知识库架构

QTRAN实际上有**三种不同类型的知识库**，分别服务于不同的目的：

---

## 1️⃣ 静态特性知识库（文件系统）

### 📁 FeatureKnowledgeBase/ - SQL数据库特性知识

```
FeatureKnowledgeBase/
├── mysql/
│   ├── function/results/        # MySQL函数文档（ABS, SIN, CONCAT等）
│   ├── operator/results/        # MySQL操作符文档
│   ├── datatype/results/        # MySQL数据类型文档
│   └── reference_table_results/ # 参考表
├── postgres/
│   ├── function/results/
│   ├── operator/results/
│   └── datatype/results/
├── sqlite/
├── mariadb/
├── clickhouse/
├── duckdb/
├── monetdb/
└── tidb/
```

**用途**：
- 📖 从官方文档提取的数据库特性
- 🔍 用于方言特征识别
- 🔄 用于特征映射（A_DB特征 → B_DB特征）
- 📚 静态参考，不会改变

**示例内容**：
```json
{
  "Name": "ABS()",
  "Description": "Returns the absolute value of X",
  "Examples": ["SELECT ABS(2);", "SELECT ABS(-32);"],
  "Category": ["Mathematical Functions"],
  "Reference HTML": "https://dev.mysql.com/doc/..."
}
```

### 📁 NoSQLFeatureKnowledgeBase/ - NoSQL数据库特性知识

```
NoSQLFeatureKnowledgeBase/
├── MongoDB/
│   ├── mongodb_knowledge_graph.json  # 操作符关系图
│   ├── mongodb_code_snippets.json    # 代码片段
│   └── extracted_api_patterns.json   # API模式
├── Redis/
│   ├── outputs/
│   │   ├── redis_commands_knowledge.json  # Redis命令知识
│   │   ├── redis_semantic_kb.json         # 语义知识库
│   │   └── parsed_examples/               # 解析的命令示例
│   └── inputs/
│       └── examples/                      # 原始示例
└── SurrealDB/
    ├── sql_to_surrealdb_mapping.json
    └── surrealdb_translation_rules.json
```

**用途**：
- 📖 NoSQL命令和API文档
- 🔄 SQL到NoSQL的映射规则
- 💡 翻译时的参考
- 📚 静态知识，手工整理或爬取

**示例内容**：
```json
{
  "operators": {
    "$eq": {
      "equivalent_forms": ["implicit_equality"],
      "used_with_methods": ["find"]
    }
  }
}
```

---

## 2️⃣ 动态运行时知识库（Qdrant向量数据库）

### 存储位置：Qdrant Collections

```
Qdrant Vector Database (http://localhost:6333)
├── qtran_transfer_memory        # 翻译阶段记忆
└── qtran_mutation_memories      # 变异阶段记忆
```

### 通过user_id区分用途

#### 📚 知识库类型（64条 - 应保留）

**qtran_transfer_universal (45条)**
- 通用翻译知识和模式
- Oracle违规模式
- 覆盖热点特征
- 跨数据库的共性规则

**qtran_*_hotspot (15条)**
- 高价值的SQL特征组合
- 容易发现bug的模式
- 用于指导fuzzing方向
- 覆盖率增益信息

**qtran_*_recommendation (4条)**
- 基于bug发现的优化建议
- 优先测试的特性
- 反向反馈机制

#### 💬 会话记忆（已清理）
- qtran_{db1}_to_{db2}: 临时翻译会话
- 缺少上下文，已删除

---

## 🔄 三者的关系和使用流程

### 翻译流程中的知识库调用：

```
1. 方言特征识别
   └→ 使用 FeatureKnowledgeBase/
      读取数据库的function/operator/datatype
      识别SQL中使用的特性

2. 特征映射
   └→ 使用 FeatureKnowledgeBase/
      A_DB特性 → B_DB等价特性
      例如: SQLite的 GLOB → DuckDB的 LIKE

3. LLM翻译
   └→ 使用 Qdrant动态知识库
      检索历史成功的翻译模式
      获取相似场景的经验

4. NoSQL翻译
   └→ 使用 NoSQLFeatureKnowledgeBase/
      SQL语句 → NoSQL命令
      参考映射规则和API文档
```

### 架构图：

```
翻译请求: "SELECT ABS(c0) FROM t0 WHERE c0 > 0"
    │
    ├─ 步骤1: 特征识别
    │   └→ FeatureKnowledgeBase/mysql/function/ABS.json
    │       提取: 函数ABS()的语义和示例
    │
    ├─ 步骤2: 特征映射
    │   └→ FeatureKnowledgeBase/duckdb/function/ABS.json
    │       映射: MySQL的ABS() → DuckDB的ABS()
    │
    ├─ 步骤3: 历史经验检索
    │   └→ Qdrant: qtran_mysql_to_duckdb (会话记忆，已删除)
    │   └→ Qdrant: qtran_transfer_universal (通用知识)
    │       检索: "ABS函数的翻译经验"
    │       检索: "WHERE条件的翻译模式"
    │
    └─ 步骤4: LLM翻译
        输入: 原SQL + 特性知识 + 历史经验
        输出: 目标数据库的SQL
```

---

## 📊 知识库对比

| 特性 | FeatureKnowledgeBase | NoSQLFeatureKnowledgeBase | Qdrant动态知识库 |
|------|---------------------|--------------------------|----------------|
| **类型** | 静态文件 | 静态文件 | 向量数据库 |
| **内容** | SQL特性文档 | NoSQL命令/API | 运行时经验 |
| **来源** | 官方文档爬取 | 手工整理 | 翻译过程积累 |
| **更新** | 手动更新 | 手动更新 | 自动积累 |
| **用途** | 特征识别+映射 | SQL→NoSQL映射 | 历史经验检索 |
| **大小** | ~数千个文件 | ~数百个文件 | 64条知识+会话 |

---

## 🎯 总结

### 你提到的两个目录：
✅ **FeatureKnowledgeBase/** - SQL数据库的**静态**特性知识库  
✅ **NoSQLFeatureKnowledgeBase/** - NoSQL数据库的**静态**特性知识库

### Qdrant中的知识库：
📚 **qtran_transfer_universal** - 通用翻译知识（**动态**积累）  
📚 **qtran_*_hotspot** - 覆盖热点（**动态**积累）  
📚 **qtran_*_recommendation** - 优化建议（**动态**积累）

### 它们的关系：
```
静态知识库（FeatureKnowledgeBase/）
  ↓ 提供基础特性信息
  
翻译过程
  ↓ 积累成功经验
  
动态知识库（Qdrant）
  ↓ 指导后续翻译
  
更好的翻译质量
```

---

## 💾 存储位置总结

1. **FeatureKnowledgeBase/** → 文件系统 `/root/QTRAN/FeatureKnowledgeBase/`
2. **NoSQLFeatureKnowledgeBase/** → 文件系统 `/root/QTRAN/NoSQLFeatureKnowledgeBase/`
3. **Mem0动态知识** → Qdrant向量数据库 `http://localhost:6333`
   - Collection: `qtran_transfer_memory`
   - Collection: `qtran_mutation_memories`

**都需要保留！** ✅

